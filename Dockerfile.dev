FROM php:8.2-fpm-alpine

# Installation des dépendances système
RUN apk add --no-cache \
    git \
    unzip \
    curl \
    libzip-dev \
    libpng-dev \
    libjpeg-turbo-dev \
    freetype-dev \
    icu-dev \
    oniguruma-dev \
    mysql-client \
    rabbitmq-c

# Installation des extensions PHP
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
        pdo \
        pdo_mysql \
        zip \
        gd \
        intl \
        mbstring \
        opcache \
        bcmath

# Installation de l'extension AMQP (via PECL) pour Symfony Messenger (Alpine)
RUN apk add --no-cache --virtual .build-deps $PHPIZE_DEPS rabbitmq-c-dev openssl-dev \
    && pecl install amqp \
    && docker-php-ext-enable amqp \
    && apk del .build-deps

# Installation de Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Configuration PHP pour développement
RUN echo "opcache.enable=1" >> /usr/local/etc/php/conf.d/opcache.ini \
    && echo "opcache.memory_consumption=256" >> /usr/local/etc/php/conf.d/opcache.ini \
    && echo "opcache.max_accelerated_files=20000" >> /usr/local/etc/php/conf.d/opcache.ini \
    && echo "opcache.validate_timestamps=1" >> /usr/local/etc/php/conf.d/opcache.ini \
    && echo "opcache.revalidate_freq=0" >> /usr/local/etc/php/conf.d/opcache.ini

# Configuration PHP-FPM pour développement
RUN echo "pm.max_children = 20" >> /usr/local/etc/php-fpm.d/www.conf \
    && echo "pm.start_servers = 3" >> /usr/local/etc/php-fpm.d/www.conf \
    && echo "pm.min_spare_servers = 2" >> /usr/local/etc/php-fpm.d/www.conf \
    && echo "pm.max_spare_servers = 5" >> /usr/local/etc/php-fpm.d/www.conf

# Répertoire de travail
WORKDIR /var/www/html

# Configuration Git pour WSL/Docker
RUN git config --global --add safe.directory /var/www/html \
    && git config --global --add safe.directory '*'

# Configuration Symfony pour développement
ENV APP_ENV=dev
ENV APP_DEBUG=1

# Exposition du port
EXPOSE 9000

# Commande par défaut
CMD ["php-fpm"]
